pipeline {
    agent any
    
    tools {
      jdk 'JAVA_1.8'
      maven 'MAVEN_3.5.2'
      git 'Default'
    }

    stages {
        stage('checkout') {
            steps {
                git branch:'developer', credentialsId: 'eficens-github-token', poll: false, url: 'https://github.com/eficensdevops/sample-web-app.git'
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn -B -DskipTests clean package'
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn test'
            }
            post {
                always {
                    junit 'server/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Sonar_Scan') {
            steps {
                withSonarQubeEnv(installationName:'SONAR_QUBE', credentialsId: 'SONAR_CREDENTIAL') { 
                sh 'mvn clean org.sonarsource.scanner.maven:sonar-maven-plugin:3.9.0.2155:sonar'
                }
            }
        }

        stage('pushto-artifactory') {
            steps {
                sh 'mvn -B -DskipTests deploy'
            }
        }
        
        stage('deploy_tomcat') {
            steps {
                echo 'deploying to tomcat'
                sshagent(['ubuntu-aws-ec2-token']) {
                    sh "scp -o StrictHostKeyChecking=no webapp/target/webapp.war ubuntu@3.84.54.232:/opt/tomcat/webapps"
                }
            }
        }
        
        stage('docker_build'){
            steps {
                dir('webapp/target') {
                    sh 'pwd'
                    sh 'ls -al'
                    sh "docker build -t hello-webapp:1.0.0 -f ${WORKSPACE}/Dockerfile ."
                    // Tag and push to some docker registry
                }
            }
        }
        
        }
